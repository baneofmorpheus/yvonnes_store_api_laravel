services:
    mysql:
        image: "mysql/mysql-server:8.0"
        ports:
            - "${FORWARD_DB_PORT:-3306}:3306"
        environment:
            MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
            MYSQL_ROOT_HOST: "%"
            MYSQL_DATABASE: "${DB_DATABASE}"
            MYSQL_USER: "${DB_USERNAME}"
            MYSQL_PASSWORD: "${DB_PASSWORD}"
            MYSQL_ALLOW_EMPTY_PASSWORD: 1
        volumes:
            - "db_data:/var/lib/mysql"
            - "./vendor/laravel/sail/database/mysql/create-testing-database.sh:/docker-entrypoint-initdb.d/10-create-testing-database.sh"
        networks:
            - yvonnes_network
        healthcheck:
            test:
                - CMD
                - mysqladmin
                - ping
                - "-p${DB_PASSWORD}"
            retries: 3
            timeout: 5s

    yvonnes-store-api:
        build: .
        env_file:
            - .env
        environment:
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT}
            - DB_DATABASE=${DB_DATABASE}
            - DB_USERNAME=${DB_USERNAME}
            - DB_PASSWORD=${DB_PASSWORD}

        ports:
            - 8000:80
        depends_on:
            mysql:
                condition: service_healthy
                restart: true
            meilisearch:
                condition: service_healthy
                restart: true
        command: /var/www/html/entrypoint.sh
        volumes:
            - ".:/var/www/html"
            - "/var/www/html/.git/"
        networks:
            - yvonnes_network

    meilisearch:
        image: "getmeili/meilisearch:latest"
        ports:
            - "${FORWARD_MEILISEARCH_PORT:-7700}:7700"
        environment:
            MEILI_NO_ANALYTICS: "${MEILISEARCH_NO_ANALYTICS:-false}"
            MEILI_MASTER_KEY: "${MEILISEARCH_KEY}"
        volumes:
            - "meilisearch_data:/meili_data"
        networks:
            - yvonnes_network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--spider",
                    "http://127.0.0.1:7700/health",
                ]
            retries: 3
            timeout: 5s
            start_period: 15s

networks:
    yvonnes_network:
        driver: bridge

volumes:
    db_data:
    meilisearch_data:
